
<!DOCTYPE html>
<html lang="en">
<head>
  <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700,400italic' rel='stylesheet' type='text/css'>

    <link rel="stylesheet" type="text/css" href="./theme/stylesheet/style.min.css">

  <!-- <link rel="stylesheet" type="text/css" href="./theme/pygments/github.min.css"> -->
  <link rel="stylesheet" type="text/css" href="./theme/font-awesome/css/font-awesome.min.css">





  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="" />


<meta name="author" content="kyle thomas" />
<meta name="description" content="The NFL season is upon us. Most pundits can barely pick over 50% of the games right. Can we use machine learning techniques to beat them? Using a PostgreSQL database, we can build statistical tables that fed into a logistic regression model to predict home team wins. We also strengthen our model using ridge regression, scaling, and cross validation." />
<meta name="keywords" content="python, machine-learning, regression, sql, postgresql, nfl">
<meta property="og:site_name" content="cmd+build"/>
<meta property="og:title" content="Predicting NFL Wins with SQL and Logistic Regression"/>
<meta property="og:description" content="The NFL season is upon us. Most pundits can barely pick over 50% of the games right. Can we use machine learning techniques to beat them? Using a PostgreSQL database, we can build statistical tables that fed into a logistic regression model to predict home team wins. We also strengthen our model using ridge regression, scaling, and cross validation."/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="./nfl-prediction-1.html"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2017-09-04 00:00:00-04:00"/>
<meta property="article:modified_time" content=""/>
<meta property="article:author" content="./author/kyle-thomas.html">
<meta property="article:section" content="tech"/>
<meta property="article:tag" content="python"/>
<meta property="article:tag" content="machine-learning"/>
<meta property="article:tag" content="regression"/>
<meta property="article:tag" content="sql"/>
<meta property="article:tag" content="postgresql"/>
<meta property="article:tag" content="nfl"/>
<meta property="og:image" content="">

  <title>cmd+build &ndash; Predicting NFL Wins with SQL and Logistic Regression</title>

</head>
<body>
  <aside>
    <div>
      <a href=".">
        <img src="./theme/img/profile.png" alt="" title="">
      </a>
      <h1><a href="."></a></h1>


      <ul class="social">
        <li><a class="sc-github" href="https://github.com/tkthomas27" target="_blank"><i class="fa fa-github"></i></a></li>
        <li><a class="sc-linkedin" href="www.linkedin.com/in/timothykylethomas" target="_blank"><i class="fa fa-linkedin"></i></a></li>
        <li><a class="sc-twitter" href="https://twitter.com/tkylethomas27" target="_blank"><i class="fa fa-twitter"></i></a></li>
      </ul>
    

      <nav>
        <ul class="list">

          <li><a href="/about.html" target="_blank">About</a></li>
          <li><a href="/archives.html" target="_blank">Archives</a></li>
          <li><a href="/categories.html" target="_blank">Categories</a></li>
          <li><a href="/tags.html" target="_blank">Tags</a></li>
        </ul>
      </nav>

  </div>



  </aside>
  <main>


<article class="single">
  <header>
    <h1 id="nfl-prediction-1">Predicting NFL Wins with SQL and Logistic Regression</h1>
    <p>
          Posted on Mon 04 September 2017 in <a href="./category/tech.html">tech</a>


    </p>
  </header>


  <div>
    
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Initialization">Initialization<a class="anchor-link" href="#Initialization">¶</a></h1><p>NFL season is upon us so let's engage in the time honored ritual of futilely trying to predict games that a coin flip would do a better job at predicting.</p>
<p>In this post we will:</p>
<ul>
<li>munge our NFL data</li>
<li>deploy a logistic regression for prediction</li>
</ul>
<p>This might seem simple but munging data is always the time-intensive part of the project. Logistic regression will be used to predict the binary classifier <code>home_win</code>. This model will be overly simplistic and is really just a proof of concept that we can successfully access, manipulate, and usefully deploy the NFL data. Later posts will posit more sophisticated models.</p>
<p>If you are not familiar with logistic regression, just know that it is a modified version of linear regression designed for binary independent variables. In this case, our independent variable will be <code>home_win</code> and our dependent variables will will be rolling team statistics that we take difference of between home and away teams.</p>
<p>If you need help getting started with NFLDB, PostgreSQL, and Python, please see my other post <a href="http://timothykylethomas.me/nfldb-postgresql.html">Getting started with NFLDB, PostgreSQL, and Python</a>.</p>
<p>First thing we need to do is import our libraries and connect to PostgreSQL.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [1]:</div>
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">'ignore'</span><span class="p">)</span>

<span class="c1"># import pandas and numpy for </span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="c1"># connect to PostgreSQL</span>
<span class="kn">import</span> <span class="nn">psycopg2</span>
<span class="n">conn</span><span class="o">=</span><span class="n">psycopg2</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s2">"dbname='nfldb' user='kthomas1' host='localhost' password='' port=5432"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Game-Results">Game Results<a class="anchor-link" href="#Game-Results">¶</a></h1><p>Interestingly, there is no <code>win</code> variable in nfldb, so out first order of business is to create the variable <code>home_win</code>. We will also create a variable <code>away_win</code> and <code>tie</code> in case we find those useful later. Note that the way we generate the <code>home_win</code> variable is through a list comprehension. For those of you new to Python, this is one of the key differentiating features of Python.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [2]:</div>
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># query game results</span>
<span class="n">game_results</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span><span class="s2">"""select season_year, week, home_team, home_score, away_team, away_score</span>
<span class="s2">from game</span>
<span class="s2">where season_type='Regular'"""</span><span class="p">,</span><span class="n">con</span><span class="o">=</span><span class="n">conn</span><span class="p">)</span>

<span class="c1"># replace la with stl</span>
<span class="n">game_results</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">to_replace</span><span class="o">=</span><span class="s1">'LA'</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s1">'STL'</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># compute wins and ties</span>
<span class="n">game_results</span><span class="p">[</span><span class="s1">'home_win'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span> <span class="k">if</span> <span class="n">x</span><span class="o">></span><span class="n">y</span> <span class="k">else</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">game_results</span><span class="p">[</span><span class="s1">'home_score'</span><span class="p">],</span><span class="n">game_results</span><span class="p">[</span><span class="s1">'away_score'</span><span class="p">])]</span>
<span class="n">game_results</span><span class="p">[</span><span class="s1">'away_win'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span> <span class="k">if</span> <span class="n">x</span><span class="o"><</span><span class="n">y</span> <span class="k">else</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">game_results</span><span class="p">[</span><span class="s1">'home_score'</span><span class="p">],</span><span class="n">game_results</span><span class="p">[</span><span class="s1">'away_score'</span><span class="p">])]</span>
<span class="n">game_results</span><span class="p">[</span><span class="s1">'tie'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span> <span class="k">if</span> <span class="n">x</span><span class="o">==</span><span class="n">y</span> <span class="k">else</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">game_results</span><span class="p">[</span><span class="s1">'home_score'</span><span class="p">],</span><span class="n">game_results</span><span class="p">[</span><span class="s1">'away_score'</span><span class="p">])]</span>

<span class="c1"># sort the dataframe</span>
<span class="n">game_results</span><span class="o">=</span><span class="n">game_results</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">'season_year'</span><span class="p">,</span><span class="s1">'home_team'</span><span class="p">,</span><span class="s1">'week'</span><span class="p">])</span>

<span class="c1"># rename the year</span>
<span class="n">game_results</span><span class="o">=</span><span class="n">game_results</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'season_year'</span><span class="p">:</span><span class="s1">'year'</span><span class="p">})</span>

<span class="c1"># print first 10 entries</span>
<span class="n">game_results</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt output_prompt">Out[2]:</div>
<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th></th>
<th>year</th>
<th>week</th>
<th>home_team</th>
<th>home_score</th>
<th>away_team</th>
<th>away_score</th>
<th>home_win</th>
<th>away_win</th>
<th>tie</th>
</tr>
</thead>
<tbody>
<tr>
<th>864</th>
<td>2009</td>
<td>1</td>
<td>ARI</td>
<td>16</td>
<td>SF</td>
<td>20</td>
<td>0</td>
<td>1</td>
<td>0</td>
</tr>
<tr>
<th>153</th>
<td>2009</td>
<td>3</td>
<td>ARI</td>
<td>10</td>
<td>IND</td>
<td>31</td>
<td>0</td>
<td>1</td>
<td>0</td>
</tr>
<tr>
<th>250</th>
<td>2009</td>
<td>5</td>
<td>ARI</td>
<td>28</td>
<td>HOU</td>
<td>21</td>
<td>1</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<th>727</th>
<td>2009</td>
<td>8</td>
<td>ARI</td>
<td>21</td>
<td>CAR</td>
<td>34</td>
<td>0</td>
<td>1</td>
<td>0</td>
</tr>
<tr>
<th>281</th>
<td>2009</td>
<td>10</td>
<td>ARI</td>
<td>31</td>
<td>SEA</td>
<td>20</td>
<td>1</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<th>829</th>
<td>2009</td>
<td>13</td>
<td>ARI</td>
<td>30</td>
<td>MIN</td>
<td>17</td>
<td>1</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<th>917</th>
<td>2009</td>
<td>16</td>
<td>ARI</td>
<td>31</td>
<td>STL</td>
<td>10</td>
<td>1</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<th>361</th>
<td>2009</td>
<td>17</td>
<td>ARI</td>
<td>7</td>
<td>GB</td>
<td>33</td>
<td>0</td>
<td>1</td>
<td>0</td>
</tr>
<tr>
<th>860</th>
<td>2009</td>
<td>1</td>
<td>ATL</td>
<td>19</td>
<td>MIA</td>
<td>7</td>
<td>1</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<th>1115</th>
<td>2009</td>
<td>2</td>
<td>ATL</td>
<td>28</td>
<td>CAR</td>
<td>20</td>
<td>1</td>
<td>0</td>
<td>0</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>I doubled checked a few of these and the data looks good. As a baseline for our predictive model, we will use the simple algorithm of always picking the home team to win.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [3]:</div>
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># total number of games</span>
<span class="n">total_games</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">game_results</span><span class="p">)</span>

<span class="c1"># total number of home wins</span>
<span class="n">home_wins</span> <span class="o">=</span> <span class="n">game_results</span><span class="o">.</span><span class="n">home_win</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

<span class="c1"># total home wins/total number of games</span>
<span class="n">home_win_rate</span> <span class="o">=</span> <span class="n">home_wins</span><span class="o">/</span><span class="n">total_games</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">"Home Team Win Rate: </span><span class="si">{:.2f}</span><span class="s2">% "</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">home_win_rate</span><span class="o">*</span><span class="mi">100</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>Home Team Win Rate: 56.35% 
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Stats">Stats<a class="anchor-link" href="#Stats">¶</a></h1><p>Now we need to process the statistics that will act as our dependent variables in the logistic regression. Broadly, this process will have the following steps:</p>
<ol>
<li>Query the statistics data</li>
<li>Encode points and turnovers</li>
<li>Split into Defensive and Offensive Statistics</li>
<li>Compute lagged 5 week rolling sums </li>
<li>Compute the difference between these values for each home and away team</li>
</ol>
<p>Encoding points and turnovers means that we will turn the word "Touchdown" ("Field Goal") into the number 7(3). Various other results are flagged as turnovers and encode as the number 1.</p>
<p>By lagged 5 week rolling sums I mean that each week will have a teams previous 5 weeks of points, turnovers, etc. For example, the number of turnovers for Arizona in week 7 will be the sum of turnovers from weeks 2-6. <strong>The choice of 5 is arbitrary.</strong> A more thorough analysis will model AIC, R2, etc as we modulate this hyperparameter.</p>
<p>We then take the difference between the rolled sums between home and away teams. Again this is somewhat arbitrary. We could just as easily use the levels as our dependent variables. One motivation is that the differences will help the variables be on more similar scales. Another motivation is that the more points, the less turnovers a team has vs their opponent might be a better predictor than just the raw amount. As with any statistical analysis, these arbitrary decisions end up being more important than any statistical model.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [4]:</div>
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">stats</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span><span class="s2">"""select drive.pos_team, drive.drive_id, drive.pos_time, drive.first_downs, drive.yards_gained, drive.play_count, drive.result, game.season_year, game.week, game.season_type, game.home_team, game.away_team</span>
<span class="s2">from drive</span>
<span class="s2">inner join game on drive.gsis_id=game.gsis_id</span>
<span class="s2">where season_type='Regular'"""</span><span class="p">,</span><span class="n">con</span><span class="o">=</span><span class="n">conn</span><span class="p">)</span>

<span class="c1">#replace la with stl</span>
<span class="n">stats</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">to_replace</span><span class="o">=</span><span class="s1">'LA'</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s1">'STL'</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># encode points results</span>
<span class="n">stats</span><span class="p">[</span><span class="s1">'points'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span> <span class="k">if</span> <span class="n">x</span><span class="o">==</span><span class="s2">"Field Goal"</span> <span class="k">else</span> <span class="mi">7</span> <span class="k">if</span> <span class="n">x</span><span class="o">==</span><span class="s2">"Touchdown"</span> <span class="k">else</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">stats</span><span class="p">[</span><span class="s1">'result'</span><span class="p">]]</span>

<span class="c1"># encode turnover results</span>
<span class="n">stats</span><span class="p">[</span><span class="s1">'turnover'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span> <span class="k">if</span> <span class="n">x</span><span class="o">==</span><span class="p">(</span><span class="s2">"Interception"</span> <span class="ow">or</span> <span class="s2">"Fumble"</span> <span class="ow">or</span> <span class="s2">"Safety"</span> <span class="ow">or</span> <span class="s2">"Blocked FG"</span> <span class="ow">or</span> <span class="s2">"Fumble, Safety"</span> <span class="ow">or</span> <span class="s2">"Blocked Punt"</span> <span class="ow">or</span> <span class="s2">"Blocked Punt, Downs"</span> <span class="ow">or</span> <span class="s2">"Blocked FG, Downs"</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">stats</span><span class="p">[</span><span class="s1">'result'</span><span class="p">]]</span>

<span class="c1"># look at the table</span>
<span class="n">stats</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt output_prompt">Out[4]:</div>
<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th></th>
<th>pos_team</th>
<th>drive_id</th>
<th>pos_time</th>
<th>first_downs</th>
<th>yards_gained</th>
<th>play_count</th>
<th>result</th>
<th>season_year</th>
<th>week</th>
<th>season_type</th>
<th>home_team</th>
<th>away_team</th>
<th>points</th>
<th>turnover</th>
</tr>
</thead>
<tbody>
<tr>
<th>0</th>
<td>MIA</td>
<td>16</td>
<td>(2)</td>
<td>0</td>
<td>0</td>
<td>2</td>
<td>End of Half</td>
<td>2009</td>
<td>7</td>
<td>Regular</td>
<td>MIA</td>
<td>NO</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<th>1</th>
<td>PIT</td>
<td>1</td>
<td>(104)</td>
<td>0</td>
<td>2</td>
<td>5</td>
<td>Punt</td>
<td>2009</td>
<td>1</td>
<td>Regular</td>
<td>PIT</td>
<td>TEN</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<th>2</th>
<td>TEN</td>
<td>2</td>
<td>(112)</td>
<td>0</td>
<td>2</td>
<td>4</td>
<td>Punt</td>
<td>2009</td>
<td>1</td>
<td>Regular</td>
<td>PIT</td>
<td>TEN</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<th>3</th>
<td>PIT</td>
<td>3</td>
<td>(184)</td>
<td>1</td>
<td>2</td>
<td>6</td>
<td>Punt</td>
<td>2009</td>
<td>1</td>
<td>Regular</td>
<td>PIT</td>
<td>TEN</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<th>4</th>
<td>TEN</td>
<td>4</td>
<td>(96)</td>
<td>3</td>
<td>55</td>
<td>6</td>
<td>Missed FG</td>
<td>2009</td>
<td>1</td>
<td>Regular</td>
<td>PIT</td>
<td>TEN</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<th>5</th>
<td>PIT</td>
<td>5</td>
<td>(115)</td>
<td>0</td>
<td>-6</td>
<td>4</td>
<td>Punt</td>
<td>2009</td>
<td>1</td>
<td>Regular</td>
<td>PIT</td>
<td>TEN</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<th>6</th>
<td>TEN</td>
<td>6</td>
<td>(191)</td>
<td>2</td>
<td>35</td>
<td>7</td>
<td>Interception</td>
<td>2009</td>
<td>1</td>
<td>Regular</td>
<td>PIT</td>
<td>TEN</td>
<td>0</td>
<td>1</td>
</tr>
<tr>
<th>7</th>
<td>PIT</td>
<td>7</td>
<td>(92)</td>
<td>0</td>
<td>3</td>
<td>3</td>
<td>Interception</td>
<td>2009</td>
<td>1</td>
<td>Regular</td>
<td>PIT</td>
<td>TEN</td>
<td>0</td>
<td>1</td>
</tr>
<tr>
<th>8</th>
<td>TEN</td>
<td>8</td>
<td>(122)</td>
<td>1</td>
<td>0</td>
<td>7</td>
<td>Punt</td>
<td>2009</td>
<td>1</td>
<td>Regular</td>
<td>PIT</td>
<td>TEN</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<th>9</th>
<td>PIT</td>
<td>9</td>
<td>(350)</td>
<td>2</td>
<td>53</td>
<td>11</td>
<td>Punt</td>
<td>2009</td>
<td>1</td>
<td>Regular</td>
<td>PIT</td>
<td>TEN</td>
<td>0</td>
<td>0</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Since we are trying to predict next weeks results, we need (1) flag what next week will be (2) add blank statistical columns for that week to the dataset. We need to add blank columns because there are no statistics for next week available yet.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [5]:</div>
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#add next weeks stats</span>
<span class="n">games_17</span> <span class="o">=</span> <span class="n">game_results</span><span class="p">[</span><span class="n">game_results</span><span class="p">[</span><span class="s1">'year'</span><span class="p">]</span><span class="o">==</span><span class="mi">2017</span><span class="p">]</span>
<span class="n">year</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">2017</span><span class="p">]</span><span class="o">*</span><span class="mi">32</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
<span class="n">week</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="nb">max</span><span class="p">(</span><span class="n">games_17</span><span class="o">.</span><span class="n">week</span><span class="p">))]</span><span class="o">*</span><span class="mi">32</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
<span class="n">team</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">stats</span><span class="o">.</span><span class="n">pos_team</span><span class="p">))),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
<span class="n">nweek</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">([</span><span class="n">year</span><span class="p">,</span><span class="n">week</span><span class="p">,</span><span class="n">team</span><span class="p">]),</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">'year'</span><span class="p">,</span><span class="s1">'week'</span><span class="p">,</span><span class="s1">'team'</span><span class="p">])</span>
<span class="n">nweek</span><span class="p">[</span><span class="s1">'year'</span><span class="p">]</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">nweek</span><span class="o">.</span><span class="n">year</span><span class="p">)</span>
<span class="n">nweek</span><span class="p">[</span><span class="s1">'week'</span><span class="p">]</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">nweek</span><span class="o">.</span><span class="n">week</span><span class="p">)</span>
<span class="n">nweek_d</span> <span class="o">=</span> <span class="n">nweek</span>
<span class="n">nweek_o</span> <span class="o">=</span> <span class="n">nweek</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Defensive-Statistics">Defensive Statistics<a class="anchor-link" href="#Defensive-Statistics">¶</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [6]:</div>
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># defense</span>
<span class="n">stats_d</span> <span class="o">=</span> <span class="n">stats</span>
<span class="n">stats_d</span><span class="p">[</span><span class="s1">'opp_team'</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">stats_d</span><span class="p">[</span><span class="s1">'pos_team'</span><span class="p">]</span><span class="o">==</span><span class="n">stats_d</span><span class="p">[</span><span class="s1">'home_team'</span><span class="p">],</span> <span class="n">stats_d</span><span class="p">[</span><span class="s1">'away_team'</span><span class="p">],</span> <span class="n">stats_d</span><span class="p">[</span><span class="s1">'home_team'</span><span class="p">])</span>
<span class="c1">#subset to defensive stats</span>
<span class="n">stats_d</span> <span class="o">=</span> <span class="n">stats_d</span><span class="p">[[</span><span class="s1">'season_year'</span><span class="p">,</span><span class="s1">'week'</span><span class="p">,</span><span class="s1">'opp_team'</span><span class="p">,</span><span class="s1">'yards_gained'</span><span class="p">,</span><span class="s1">'points'</span><span class="p">,</span><span class="s1">'turnover'</span><span class="p">]]</span>
<span class="c1"># rename columns</span>
<span class="n">stats_d</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'year'</span><span class="p">,</span><span class="s1">'week'</span><span class="p">,</span><span class="s1">'team'</span><span class="p">,</span><span class="s1">'yards_allowed'</span><span class="p">,</span><span class="s1">'points_allowed'</span><span class="p">,</span><span class="s1">'turnovers_forced'</span><span class="p">]</span>

<span class="c1">#add next week</span>
<span class="n">stats_d</span> <span class="o">=</span> <span class="n">stats_d</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nweek_d</span><span class="p">)</span>

<span class="c1"># aggregate rolling 5 week</span>
<span class="c1">## sort at year, team, week</span>
<span class="n">stats_d</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">'team'</span><span class="p">,</span><span class="s1">'year'</span><span class="p">,</span><span class="s1">'week'</span><span class="p">],</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="c1">## sum across year team week</span>
<span class="n">stats_d</span><span class="o">=</span><span class="n">stats_d</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">'team'</span><span class="p">,</span><span class="s1">'year'</span><span class="p">,</span><span class="s1">'week'</span><span class="p">],</span><span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="c1">## rolling 2 week lagged</span>
<span class="n">rolling</span> <span class="o">=</span> <span class="n">stats_d</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">'team'</span><span class="p">],</span><span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="s1">'yards_allowed'</span><span class="p">,</span><span class="s1">'points_allowed'</span><span class="p">,</span><span class="s1">'turnovers_forced'</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="c1">## join together</span>
<span class="n">stats_d</span><span class="o">=</span><span class="n">stats_d</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rolling</span><span class="p">,</span><span class="n">lsuffix</span><span class="o">=</span><span class="s1">'_weekly'</span><span class="p">,</span><span class="n">rsuffix</span><span class="o">=</span><span class="s1">'_rolling'</span><span class="p">)</span>

<span class="n">stats_d</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt output_prompt">Out[6]:</div>
<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th></th>
<th>team</th>
<th>year</th>
<th>week</th>
<th>points_allowed_weekly</th>
<th>turnovers_forced_weekly</th>
<th>yards_allowed_weekly</th>
<th>level_0</th>
<th>level_1</th>
<th>yards_allowed_rolling</th>
<th>points_allowed_rolling</th>
<th>turnovers_forced_rolling</th>
</tr>
</thead>
<tbody>
<tr>
<th>0</th>
<td>ARI</td>
<td>2009</td>
<td>1</td>
<td>20.0</td>
<td>0.0</td>
<td>203.0</td>
<td>0</td>
<td>0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr>
<th>1</th>
<td>ARI</td>
<td>2009</td>
<td>2</td>
<td>17.0</td>
<td>1.0</td>
<td>367.0</td>
<td>0</td>
<td>1</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr>
<th>2</th>
<td>ARI</td>
<td>2009</td>
<td>3</td>
<td>31.0</td>
<td>1.0</td>
<td>501.0</td>
<td>0</td>
<td>2</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr>
<th>3</th>
<td>ARI</td>
<td>2009</td>
<td>5</td>
<td>21.0</td>
<td>1.0</td>
<td>414.0</td>
<td>0</td>
<td>3</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr>
<th>4</th>
<td>ARI</td>
<td>2009</td>
<td>6</td>
<td>3.0</td>
<td>1.0</td>
<td>128.0</td>
<td>0</td>
<td>4</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr>
<th>5</th>
<td>ARI</td>
<td>2009</td>
<td>7</td>
<td>17.0</td>
<td>3.0</td>
<td>327.0</td>
<td>0</td>
<td>5</td>
<td>1613.0</td>
<td>92.0</td>
<td>4.0</td>
</tr>
<tr>
<th>6</th>
<td>ARI</td>
<td>2009</td>
<td>8</td>
<td>27.0</td>
<td>0.0</td>
<td>355.0</td>
<td>0</td>
<td>6</td>
<td>1737.0</td>
<td>89.0</td>
<td>7.0</td>
</tr>
<tr>
<th>7</th>
<td>ARI</td>
<td>2009</td>
<td>9</td>
<td>21.0</td>
<td>1.0</td>
<td>417.0</td>
<td>0</td>
<td>7</td>
<td>1725.0</td>
<td>99.0</td>
<td>6.0</td>
</tr>
<tr>
<th>8</th>
<td>ARI</td>
<td>2009</td>
<td>10</td>
<td>20.0</td>
<td>2.0</td>
<td>472.0</td>
<td>0</td>
<td>8</td>
<td>1641.0</td>
<td>89.0</td>
<td>6.0</td>
</tr>
<tr>
<th>9</th>
<td>ARI</td>
<td>2009</td>
<td>11</td>
<td>13.0</td>
<td>1.0</td>
<td>314.0</td>
<td>0</td>
<td>9</td>
<td>1699.0</td>
<td>88.0</td>
<td>7.0</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>So it appears that the code above is working. If you add the yards allowed by Arizona from weeks 1-5 you do indeed get the rolling yards allowed for week 7 (Arizona had a bye week during the 4th week).</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Offensive-Statistics">Offensive Statistics<a class="anchor-link" href="#Offensive-Statistics">¶</a></h2><p>Offensive statistics are generated in a similar way to the defensive statistics. In fact, it is easier because we do not need to flag the opposing team.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [7]:</div>
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># offense</span>
<span class="n">stats_o</span> <span class="o">=</span> <span class="n">stats</span>
<span class="n">stats_o</span><span class="o">=</span><span class="n">stats_o</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'pos_team'</span><span class="p">:</span><span class="s1">'team'</span><span class="p">})</span>
<span class="n">stats_o</span><span class="o">=</span><span class="n">stats_o</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'season_year'</span><span class="p">:</span><span class="s1">'year'</span><span class="p">})</span>
<span class="n">stats_o</span> <span class="o">=</span> <span class="n">stats_o</span><span class="p">[[</span><span class="s1">'team'</span><span class="p">,</span><span class="s1">'year'</span><span class="p">,</span><span class="s1">'week'</span><span class="p">,</span><span class="s1">'first_downs'</span><span class="p">,</span><span class="s1">'yards_gained'</span><span class="p">,</span><span class="s1">'play_count'</span><span class="p">,</span><span class="s1">'points'</span><span class="p">,</span><span class="s1">'turnover'</span><span class="p">]]</span>

<span class="c1">#add next week</span>
<span class="n">stats_o</span> <span class="o">=</span> <span class="n">stats_o</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nweek_o</span><span class="p">)</span>

<span class="c1"># aggregate rolling 5 week</span>
<span class="c1">## sort at year, team, week</span>
<span class="n">stats_o</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">'team'</span><span class="p">,</span><span class="s1">'year'</span><span class="p">,</span><span class="s1">'week'</span><span class="p">],</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="c1">## sum across year team week</span>
<span class="n">stats_o</span><span class="o">=</span><span class="n">stats_o</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">'team'</span><span class="p">,</span><span class="s1">'year'</span><span class="p">,</span><span class="s1">'week'</span><span class="p">],</span><span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="c1">## rolling 5 week lagged</span>
<span class="n">rolling</span> <span class="o">=</span> <span class="n">stats_o</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">'team'</span><span class="p">],</span><span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="s1">'first_downs'</span><span class="p">,</span><span class="s1">'yards_gained'</span><span class="p">,</span><span class="s1">'play_count'</span><span class="p">,</span><span class="s1">'points'</span><span class="p">,</span><span class="s1">'turnover'</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="c1">## join together</span>
<span class="n">stats_o</span><span class="o">=</span><span class="n">stats_o</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rolling</span><span class="p">,</span><span class="n">lsuffix</span><span class="o">=</span><span class="s1">'_weekly'</span><span class="p">,</span><span class="n">rsuffix</span><span class="o">=</span><span class="s1">'_rolling'</span><span class="p">)</span>

<span class="n">stats_o</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt output_prompt">Out[7]:</div>
<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th></th>
<th>team</th>
<th>year</th>
<th>week</th>
<th>first_downs_weekly</th>
<th>play_count_weekly</th>
<th>points_weekly</th>
<th>turnover_weekly</th>
<th>yards_gained_weekly</th>
<th>level_0</th>
<th>level_1</th>
<th>first_downs_rolling</th>
<th>yards_gained_rolling</th>
<th>play_count_rolling</th>
<th>points_rolling</th>
<th>turnover_rolling</th>
</tr>
</thead>
<tbody>
<tr>
<th>0</th>
<td>ARI</td>
<td>2009</td>
<td>1</td>
<td>17.0</td>
<td>99.0</td>
<td>16.0</td>
<td>2.0</td>
<td>299.0</td>
<td>0</td>
<td>0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr>
<th>1</th>
<td>ARI</td>
<td>2009</td>
<td>2</td>
<td>22.0</td>
<td>89.0</td>
<td>24.0</td>
<td>0.0</td>
<td>388.0</td>
<td>0</td>
<td>1</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr>
<th>2</th>
<td>ARI</td>
<td>2009</td>
<td>3</td>
<td>21.0</td>
<td>97.0</td>
<td>10.0</td>
<td>2.0</td>
<td>317.0</td>
<td>0</td>
<td>2</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr>
<th>3</th>
<td>ARI</td>
<td>2009</td>
<td>5</td>
<td>19.0</td>
<td>81.0</td>
<td>21.0</td>
<td>0.0</td>
<td>340.0</td>
<td>0</td>
<td>3</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr>
<th>4</th>
<td>ARI</td>
<td>2009</td>
<td>6</td>
<td>21.0</td>
<td>100.0</td>
<td>27.0</td>
<td>1.0</td>
<td>344.0</td>
<td>0</td>
<td>4</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr>
<th>5</th>
<td>ARI</td>
<td>2009</td>
<td>7</td>
<td>15.0</td>
<td>88.0</td>
<td>24.0</td>
<td>1.0</td>
<td>288.0</td>
<td>0</td>
<td>5</td>
<td>100.0</td>
<td>1688.0</td>
<td>466.0</td>
<td>98.0</td>
<td>5.0</td>
</tr>
<tr>
<th>6</th>
<td>ARI</td>
<td>2009</td>
<td>8</td>
<td>23.0</td>
<td>91.0</td>
<td>21.0</td>
<td>5.0</td>
<td>320.0</td>
<td>0</td>
<td>6</td>
<td>98.0</td>
<td>1677.0</td>
<td>455.0</td>
<td>106.0</td>
<td>4.0</td>
</tr>
<tr>
<th>7</th>
<td>ARI</td>
<td>2009</td>
<td>9</td>
<td>27.0</td>
<td>91.0</td>
<td>41.0</td>
<td>1.0</td>
<td>438.0</td>
<td>0</td>
<td>7</td>
<td>99.0</td>
<td>1609.0</td>
<td>457.0</td>
<td>103.0</td>
<td>9.0</td>
</tr>
<tr>
<th>8</th>
<td>ARI</td>
<td>2009</td>
<td>10</td>
<td>22.0</td>
<td>98.0</td>
<td>31.0</td>
<td>0.0</td>
<td>462.0</td>
<td>0</td>
<td>8</td>
<td>105.0</td>
<td>1730.0</td>
<td>451.0</td>
<td>134.0</td>
<td>8.0</td>
</tr>
<tr>
<th>9</th>
<td>ARI</td>
<td>2009</td>
<td>11</td>
<td>24.0</td>
<td>90.0</td>
<td>21.0</td>
<td>0.0</td>
<td>442.0</td>
<td>0</td>
<td>9</td>
<td>108.0</td>
<td>1852.0</td>
<td>468.0</td>
<td>144.0</td>
<td>8.0</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Combine-Stats">Combine Stats<a class="anchor-link" href="#Combine-Stats">¶</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [8]:</div>
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># drop the level variables from offense and defensive</span>
<span class="n">stats_o</span> <span class="o">=</span> <span class="n">stats_o</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">'level_0'</span><span class="p">,</span><span class="s1">'level_1'</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">stats_d</span> <span class="o">=</span> <span class="n">stats_d</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">'level_0'</span><span class="p">,</span><span class="s1">'level_1'</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># combine offense and defense stats</span>
<span class="n">stats_od</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">stats_d</span><span class="p">,</span><span class="n">stats_o</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">stats_od</span><span class="o">=</span><span class="n">stats_od</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>

<span class="c1"># drop the year 2009 becasue of the blank weeks</span>
<span class="n">stats_od</span><span class="o">=</span><span class="n">stats_od</span><span class="p">[</span><span class="n">stats_od</span><span class="p">[</span><span class="s1">'year'</span><span class="p">]</span><span class="o">!=</span><span class="mi">2009</span><span class="p">]</span>

<span class="c1"># drop the weekly stats because we won't be needing them</span>
<span class="n">weekly_stats</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">stats_od</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">'weekly'</span><span class="p">)]</span>
<span class="n">stats_od</span> <span class="o">=</span> <span class="n">stats_od</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">weekly_stats</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># convert to numeric</span>
<span class="n">stats_od</span><span class="o">=</span><span class="n">stats_od</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">'ignore'</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Bringing-It-All-Together">Bringing It All Together<a class="anchor-link" href="#Bringing-It-All-Together">¶</a></h1>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [9]:</div>
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># create a new games dataframe from game_results</span>
<span class="n">games</span> <span class="o">=</span> <span class="n">game_results</span>

<span class="c1"># rename columns</span>
<span class="n">stats_od</span><span class="o">.</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">'team'</span><span class="p">,</span><span class="s1">'year'</span><span class="p">,</span><span class="s1">'week'</span><span class="p">,</span><span class="s1">'ya'</span><span class="p">,</span><span class="s1">'pa'</span><span class="p">,</span><span class="s1">'tf'</span><span class="p">,</span><span class="s1">'fd'</span><span class="p">,</span><span class="s1">'yg'</span><span class="p">,</span><span class="s1">'pc'</span><span class="p">,</span><span class="s1">'p'</span><span class="p">,</span><span class="s1">'t'</span><span class="p">]</span>

<span class="c1"># merge game results with stats; there need to be two merges because both home and away teams need statistics</span>
<span class="n">games</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">games</span><span class="p">,</span><span class="n">stats_od</span><span class="p">,</span><span class="n">left_on</span><span class="o">=</span><span class="p">[</span><span class="s1">'home_team'</span><span class="p">,</span><span class="s1">'year'</span><span class="p">,</span><span class="s1">'week'</span><span class="p">],</span><span class="n">right_on</span><span class="o">=</span><span class="p">[</span><span class="s1">'team'</span><span class="p">,</span><span class="s1">'year'</span><span class="p">,</span><span class="s1">'week'</span><span class="p">]),</span><span class="n">stats_od</span><span class="p">,</span><span class="n">left_on</span><span class="o">=</span><span class="p">[</span><span class="s1">'away_team'</span><span class="p">,</span><span class="s1">'year'</span><span class="p">,</span><span class="s1">'week'</span><span class="p">],</span><span class="n">right_on</span><span class="o">=</span><span class="p">[</span><span class="s1">'team'</span><span class="p">,</span><span class="s1">'year'</span><span class="p">,</span><span class="s1">'week'</span><span class="p">],</span><span class="n">suffixes</span><span class="o">=</span><span class="p">[</span><span class="s1">'_home'</span><span class="p">,</span><span class="s1">'_away'</span><span class="p">])</span>

<span class="c1"># comptue diffs for each variable</span>
<span class="n">diffs</span><span class="o">=</span><span class="p">[</span><span class="s1">'ya'</span><span class="p">,</span><span class="s1">'pa'</span><span class="p">,</span><span class="s1">'tf'</span><span class="p">,</span><span class="s1">'fd'</span><span class="p">,</span><span class="s1">'yg'</span><span class="p">,</span><span class="s1">'pc'</span><span class="p">,</span><span class="s1">'p'</span><span class="p">,</span><span class="s1">'t'</span><span class="p">]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">diffs</span><span class="p">:</span>
    <span class="n">diff_column</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="s2">"_diff"</span>
    <span class="n">home_column</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="s2">"_home"</span>
    <span class="n">away_column</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="s2">"_away"</span>
    <span class="n">games</span><span class="p">[</span><span class="n">diff_column</span><span class="p">]</span> <span class="o">=</span> <span class="n">games</span><span class="p">[</span><span class="n">home_column</span><span class="p">]</span> <span class="o">-</span> <span class="n">games</span><span class="p">[</span><span class="n">away_column</span><span class="p">]</span>

<span class="c1"># we only need the diffs, so drop all the home/away specific stats columns</span>
<span class="n">home</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">games</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">'home'</span><span class="p">)]</span>
<span class="n">away</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">games</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">'away'</span><span class="p">)]</span>
<span class="n">games</span> <span class="o">=</span> <span class="n">games</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">home</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">games</span> <span class="o">=</span> <span class="n">games</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">away</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Model">Model<a class="anchor-link" href="#Model">¶</a></h1><p>For our first stab at a logistic regression let's use <code>statsmodels</code> because it has nicer output than <code>sklearn</code>.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [12]:</div>
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">statsmodels.api</span> <span class="k">as</span> <span class="nn">sm</span>

<span class="c1"># create past games df that will be used to train our model</span>
<span class="n">past_games</span> <span class="o">=</span> <span class="n">games</span><span class="p">[(</span><span class="n">games</span><span class="p">[</span><span class="s1">'year'</span><span class="p">]</span><span class="o">!=</span><span class="nb">max</span><span class="p">(</span><span class="n">games</span><span class="o">.</span><span class="n">year</span><span class="p">))</span> <span class="o">&</span> <span class="p">(</span><span class="n">games</span><span class="p">[</span><span class="s1">'week'</span><span class="p">]</span><span class="o">!=</span><span class="nb">max</span><span class="p">(</span><span class="n">games_17</span><span class="o">.</span><span class="n">week</span><span class="p">))]</span>

<span class="c1"># create future games df that will be predicted using our trained model</span>
<span class="n">future_games</span> <span class="o">=</span> <span class="n">games</span><span class="p">[(</span><span class="n">games</span><span class="p">[</span><span class="s1">'year'</span><span class="p">]</span><span class="o">==</span><span class="nb">max</span><span class="p">(</span><span class="n">games</span><span class="o">.</span><span class="n">year</span><span class="p">))</span> <span class="o">&</span> <span class="p">(</span><span class="n">games</span><span class="p">[</span><span class="s1">'week'</span><span class="p">]</span><span class="o">==</span><span class="nb">max</span><span class="p">(</span><span class="n">games_17</span><span class="o">.</span><span class="n">week</span><span class="p">))]</span>

<span class="c1"># for statsmodels, we need to specify</span>
<span class="n">past_games</span><span class="p">[</span><span class="s1">'intercept'</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="n">future_games</span><span class="p">[</span><span class="s1">'intercept'</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>

<span class="c1"># our training columns will be the diffs</span>
<span class="n">training_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">games</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">'diff'</span><span class="p">)]</span>
<span class="c1"># need to add the intercept column</span>
<span class="n">training_cols</span> <span class="o">=</span> <span class="n">training_cols</span> <span class="o">+</span> <span class="p">[</span><span class="s2">"intercept"</span><span class="p">]</span>

<span class="c1"># perform the regression</span>
<span class="n">logit</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">Logit</span><span class="p">(</span><span class="n">past_games</span><span class="p">[</span><span class="s1">'home_win'</span><span class="p">],</span> <span class="n">past_games</span><span class="p">[</span><span class="n">training_cols</span><span class="p">])</span>

<span class="c1"># save the results and print</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">logit</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">summary</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>Optimization terminated successfully.
         Current function value: 0.642621
         Iterations 5
                           Logit Regression Results                           
==============================================================================
Dep. Variable:               home_win   No. Observations:                 1680
Model:                          Logit   Df Residuals:                     1671
Method:                           MLE   Df Model:                            8
Date:                Tue, 05 Sep 2017   Pseudo R-squ.:                 0.06125
Time:                        10:59:28   Log-Likelihood:                -1079.6
converged:                       True   LL-Null:                       -1150.0
                                        LLR p-value:                 1.561e-26
==============================================================================
                 coef    std err          z      P>|z|      [95.0% Conf. Int.]
------------------------------------------------------------------------------
ya_diff       -0.0002      0.000     -0.758      0.448        -0.001     0.000
pa_diff       -0.0070      0.002     -2.798      0.005        -0.012    -0.002
tf_diff        0.0026      0.018      0.145      0.885        -0.032     0.038
fd_diff        0.0103      0.006      1.750      0.080        -0.001     0.022
yg_diff     7.547e-05      0.000      0.218      0.827        -0.001     0.001
pc_diff       -0.0043      0.002     -2.323      0.020        -0.008    -0.001
p_diff         0.0100      0.003      3.817      0.000         0.005     0.015
t_diff        -0.0305      0.018     -1.704      0.088        -0.066     0.005
intercept      0.3114      0.052      6.019      0.000         0.210     0.413
==============================================================================
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The logistic regression model can be written as</p>
\begin{equation}
Pr(Y=1 \vert \pmb{X}) = \Lambda(\pmb{x'}\pmb{\beta})
\end{equation}<p>In our case, <em>Y</em> is <code>home_win</code> and <em>X</em> represents the collection of diffs we will use to train the model. The $\beta$s are the parameters we will estimate while $\Lambda$ represents the cumulative  logistic distribution function (Greene, 667). The probability that there is a home win given the training variables can also be written as</p>
\begin{equation}
\frac{e^{x'\beta}}{1 + e^{-(x'\beta)}}
\end{equation}<p>The general consensus is that the $\beta$s in a logistic model are difficult to interpret and not intuitive. Roughly speaking, we can say that the coefficients are changes in the log odds associated with changes in the values of X. More important, is the significance and magnitude of the coefficients. If you believe in p-values, then points, points allowed, first downs, number of plays, and turnovers are significant. Of these, turnover is the largest in magnitude being almost three times the size of the next biggest coefficient. Keep in mind these coefficients are based on changes in the differences in the five week sums between teams. For example, if Buffalo has 1 more turnover than the Jets in the past 5 weeks, their log-odds of a <code>home_win</code> decrease by -0.0305. A simple takeaway is that teams that protect the ball better---more so than scoring more points or forcing more turnovers--are more likely to win at home.</p>
<p>Because log odds are not clear, we can exponentiate them to get just regular odds. Values less than 1 indicate a decrease in odds of a home win when the associated X value increases. As we would expect, the variable with the greatest impact (the furthest from 1) is turnover differential.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [38]:</div>
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#log odds</span>
<span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>ya_diff      0.999808
pa_diff      0.993069
tf_diff      1.002592
fd_diff      1.010402
yg_diff      1.000075
pc_diff      0.995710
p_diff       1.010071
t_diff       0.969919
intercept    1.365370
dtype: float64
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Making-Predictions">Making Predictions<a class="anchor-link" href="#Making-Predictions">¶</a></h2><p>This is where the fun begins. Our model is stored in the variable <code>result</code>. We can use the method <code>predict</code> on <code>result</code> and feed it the training columns for next weeks games to get the predictions. We assume that if a team has a greater than .5 chance of winning, they will win.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [39]:</div>
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># predict the results </span>
<span class="n">preds</span><span class="o">=</span><span class="n">result</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">future_games</span><span class="p">[</span><span class="n">training_cols</span><span class="p">])</span>

<span class="c1"># add probabilities to next week</span>
<span class="n">future_games</span><span class="p">[</span><span class="s1">'win_prob'</span><span class="p">]</span> <span class="o">=</span> <span class="n">preds</span>

<span class="c1"># home team wins if team has greater than 50% chance of winning</span>
<span class="n">future_games</span><span class="p">[</span><span class="s1">'winner'</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">future_games</span><span class="p">[</span><span class="s1">'win_prob'</span><span class="p">]</span><span class="o">>.</span><span class="mi">5</span><span class="p">,</span><span class="n">future_games</span><span class="p">[</span><span class="s1">'home_team'</span><span class="p">],</span><span class="n">future_games</span><span class="p">[</span><span class="s1">'away_team'</span><span class="p">])</span>

<span class="c1"># show select columns</span>
<span class="n">future_games</span><span class="p">[[</span><span class="s1">'home_team'</span><span class="p">,</span><span class="s1">'away_team'</span><span class="p">,</span><span class="s1">'winner'</span><span class="p">,</span><span class="s1">'win_prob'</span><span class="p">]]</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt output_prompt">Out[39]:</div>
<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th></th>
<th>home_team</th>
<th>away_team</th>
<th>winner</th>
<th>win_prob</th>
</tr>
</thead>
<tbody>
<tr>
<th>1792</th>
<td>BUF</td>
<td>NYJ</td>
<td>BUF</td>
<td>0.734928</td>
</tr>
<tr>
<th>1793</th>
<td>CHI</td>
<td>ATL</td>
<td>ATL</td>
<td>0.271247</td>
</tr>
<tr>
<th>1794</th>
<td>CIN</td>
<td>BAL</td>
<td>CIN</td>
<td>0.677391</td>
</tr>
<tr>
<th>1795</th>
<td>CLE</td>
<td>PIT</td>
<td>PIT</td>
<td>0.415514</td>
</tr>
<tr>
<th>1796</th>
<td>DAL</td>
<td>NYG</td>
<td>DAL</td>
<td>0.647978</td>
</tr>
<tr>
<th>1797</th>
<td>DET</td>
<td>ARI</td>
<td>ARI</td>
<td>0.466745</td>
</tr>
<tr>
<th>1798</th>
<td>GB</td>
<td>SEA</td>
<td>GB</td>
<td>0.669263</td>
</tr>
<tr>
<th>1799</th>
<td>HOU</td>
<td>JAC</td>
<td>HOU</td>
<td>0.603216</td>
</tr>
<tr>
<th>1800</th>
<td>MIA</td>
<td>TB</td>
<td>TB</td>
<td>0.493744</td>
</tr>
<tr>
<th>1801</th>
<td>MIN</td>
<td>NO</td>
<td>MIN</td>
<td>0.605072</td>
</tr>
<tr>
<th>1802</th>
<td>NE</td>
<td>KC</td>
<td>NE</td>
<td>0.713972</td>
</tr>
<tr>
<th>1803</th>
<td>SF</td>
<td>CAR</td>
<td>SF</td>
<td>0.554456</td>
</tr>
<tr>
<th>1804</th>
<td>STL</td>
<td>IND</td>
<td>IND</td>
<td>0.185217</td>
</tr>
<tr>
<th>1805</th>
<td>TEN</td>
<td>OAK</td>
<td>TEN</td>
<td>0.530964</td>
</tr>
<tr>
<th>1806</th>
<td>WAS</td>
<td>PHI</td>
<td>WAS</td>
<td>0.676628</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This table passes the smell test. The Patriots, who rarely lose at home, have a 71% chance of winning. The Jets, who many are saying could be one of the worst teams of all time this year, have the second highest probability of losing---despite playing an underwhelming Buffalo team.</p>
<h2 id="Better-Model">Better Model<a class="anchor-link" href="#Better-Model">¶</a></h2><p>While there are many improvements to be made to the model, three we will briefly deploy are:</p>
<ol>
<li>Shrinkage</li>
<li>Scaling</li>
<li>Cross Validation</li>
</ol>
<p>Shrinkage is a statistical learning technique designed to reduce the variance of a model by shrinking the coefficient towards zero. The ultimate goal is to have a model that performs consistently on different test sets. By reducing variance, we also reduce the mean squared error, thus improving the quality of the model overall.</p>
<p>To shrink our coefficients, we will use <code>sklearn</code>, a popular Python library for machine learning. One nice thing about <code>skelearn</code> is that it defaults to using a shrinkage method called ridge regression. The standard regression model attempts to minimize the sum of the squared residuals (RSS). A ridge regression uses the $\ell_2$ norm to minimize</p>
\begin{equation}
RSS + \lambda \sum_{j=1}^p \beta_j^2
\end{equation}<p>where $\lambda$ is a tuning parameter that defaults to 1.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [13]:</div>
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># import sklearn</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="k">import</span> <span class="n">LogisticRegression</span>

<span class="c1"># define sklearn logit with default intercept</span>
<span class="n">logit</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">fit_intercept</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># fit the</span>
<span class="n">logit</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">past_games</span><span class="p">[</span><span class="n">training_cols</span><span class="p">],</span><span class="n">past_games</span><span class="p">[</span><span class="s1">'home_win'</span><span class="p">])</span>

<span class="c1"># retrieve and display the probabilities</span>
<span class="n">preds</span><span class="o">=</span><span class="n">logit</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">future_games</span><span class="p">[</span><span class="n">training_cols</span><span class="p">])</span>
<span class="n">future_games</span><span class="p">[</span><span class="s1">'prediction'</span><span class="p">]</span> <span class="o">=</span> <span class="n">preds</span>
<span class="n">future_games</span><span class="p">[</span><span class="s1">'winner'</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">future_games</span><span class="p">[</span><span class="s1">'prediction'</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">,</span><span class="n">future_games</span><span class="p">[</span><span class="s1">'home_team'</span><span class="p">],</span><span class="n">future_games</span><span class="p">[</span><span class="s1">'away_team'</span><span class="p">])</span>
<span class="n">future_games</span><span class="p">[</span><span class="s1">'win_prob'</span><span class="p">]</span> <span class="o">=</span> <span class="n">logit</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">future_games</span><span class="p">[</span><span class="n">training_cols</span><span class="p">])[:,</span><span class="mi">1</span><span class="p">]</span>
<span class="n">future_games</span><span class="p">[[</span><span class="s1">'home_team'</span><span class="p">,</span><span class="s1">'away_team'</span><span class="p">,</span><span class="s1">'winner'</span><span class="p">,</span><span class="s1">'win_prob'</span><span class="p">]]</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt output_prompt">Out[13]:</div>
<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th></th>
<th>home_team</th>
<th>away_team</th>
<th>winner</th>
<th>win_prob</th>
</tr>
</thead>
<tbody>
<tr>
<th>1792</th>
<td>BUF</td>
<td>NYJ</td>
<td>BUF</td>
<td>0.734825</td>
</tr>
<tr>
<th>1793</th>
<td>CHI</td>
<td>ATL</td>
<td>ATL</td>
<td>0.271191</td>
</tr>
<tr>
<th>1794</th>
<td>CIN</td>
<td>BAL</td>
<td>CIN</td>
<td>0.677282</td>
</tr>
<tr>
<th>1795</th>
<td>CLE</td>
<td>PIT</td>
<td>PIT</td>
<td>0.415410</td>
</tr>
<tr>
<th>1796</th>
<td>DAL</td>
<td>NYG</td>
<td>DAL</td>
<td>0.647876</td>
</tr>
<tr>
<th>1797</th>
<td>DET</td>
<td>ARI</td>
<td>ARI</td>
<td>0.466641</td>
</tr>
<tr>
<th>1798</th>
<td>GB</td>
<td>SEA</td>
<td>GB</td>
<td>0.669158</td>
</tr>
<tr>
<th>1799</th>
<td>HOU</td>
<td>JAC</td>
<td>HOU</td>
<td>0.603107</td>
</tr>
<tr>
<th>1800</th>
<td>MIA</td>
<td>TB</td>
<td>TB</td>
<td>0.493659</td>
</tr>
<tr>
<th>1801</th>
<td>MIN</td>
<td>NO</td>
<td>MIN</td>
<td>0.604957</td>
</tr>
<tr>
<th>1802</th>
<td>NE</td>
<td>KC</td>
<td>NE</td>
<td>0.713873</td>
</tr>
<tr>
<th>1803</th>
<td>SF</td>
<td>CAR</td>
<td>SF</td>
<td>0.554342</td>
</tr>
<tr>
<th>1804</th>
<td>STL</td>
<td>IND</td>
<td>IND</td>
<td>0.185181</td>
</tr>
<tr>
<th>1805</th>
<td>TEN</td>
<td>OAK</td>
<td>TEN</td>
<td>0.530865</td>
</tr>
<tr>
<th>1806</th>
<td>WAS</td>
<td>PHI</td>
<td>WAS</td>
<td>0.676535</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Using the ridge regression we get slightly different probabilities but ultimately the same picks.</p>
<p>Many regression methods---in particular ridge regression---work best when the dependent variables equally scaled. We can use <code>sklearn</code> to standardize the variables to have mean zero and standard deviation of one.</p>
<p>As an additional check on the model also use <code>sklearn</code> to cross validate our model. Cross validation is a crucial machine learning technique and should almost always be used. After shrinking, scaling, and cross validating our model we can check the overall accuracy.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [23]:</div>
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn</span> <span class="k">import</span> <span class="n">preprocessing</span>
<span class="kn">from</span> <span class="nn">sklearn</span> <span class="k">import</span> <span class="n">metrics</span><span class="p">,</span> <span class="n">cross_validation</span>

<span class="c1"># scale</span>
<span class="n">past_games_scaled</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">preprocessing</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="n">past_games</span><span class="p">[</span><span class="n">training_cols</span><span class="p">]))</span>

<span class="c1"># cross validate</span>
<span class="n">scores</span> <span class="o">=</span> <span class="n">cross_validation</span><span class="o">.</span><span class="n">cross_val_score</span><span class="p">(</span><span class="n">logit</span><span class="p">,</span> <span class="n">past_games_scaled</span><span class="p">,</span> <span class="n">past_games</span><span class="p">[</span><span class="s1">'home_win'</span><span class="p">],</span> <span class="n">cv</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="c1"># accuracy</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Accuracy: </span><span class="si">%0.2f</span><span class="s2"> (+/- </span><span class="si">%0.2f</span><span class="s2">)"</span> <span class="o">%</span> <span class="p">(</span><span class="n">scores</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">scores</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="mi">2</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>Accuracy: 0.63 (+/- 0.05)
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>So our new model has a 63% accuracy which is better than always picking the home team (53%).</p>
<p>The <code>cross_validation</code> module form <code>sklearn</code> will only provide the model score. If we want to cross validate and see the predicted probabilities, we need to use the <code>LogisticRegressionCV</code> module.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [24]:</div>
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># import cross validated logistic regression</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="k">import</span> <span class="n">LogisticRegressionCV</span>

<span class="c1"># define sklearn logit with default intercept</span>
<span class="n">logitcv</span> <span class="o">=</span> <span class="n">LogisticRegressionCV</span><span class="p">()</span>

<span class="c1"># fit the</span>
<span class="n">logitcv</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">past_games</span><span class="p">[</span><span class="n">training_cols</span><span class="p">],</span><span class="n">past_games</span><span class="p">[</span><span class="s1">'home_win'</span><span class="p">])</span>

<span class="n">preds</span><span class="o">=</span><span class="n">logitcv</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">future_games</span><span class="p">[</span><span class="n">training_cols</span><span class="p">])</span>
<span class="n">future_games</span><span class="p">[</span><span class="s1">'prediction'</span><span class="p">]</span> <span class="o">=</span> <span class="n">preds</span>
<span class="n">future_games</span><span class="p">[</span><span class="s1">'winner'</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">future_games</span><span class="p">[</span><span class="s1">'prediction'</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">,</span><span class="n">future_games</span><span class="p">[</span><span class="s1">'home_team'</span><span class="p">],</span><span class="n">future_games</span><span class="p">[</span><span class="s1">'away_team'</span><span class="p">])</span>
<span class="n">future_games</span><span class="p">[</span><span class="s1">'win_prob'</span><span class="p">]</span> <span class="o">=</span> <span class="n">logitcv</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">future_games</span><span class="p">[</span><span class="n">training_cols</span><span class="p">])[:,</span><span class="mi">1</span><span class="p">]</span>
<span class="n">future_games</span><span class="p">[[</span><span class="s1">'home_team'</span><span class="p">,</span><span class="s1">'away_team'</span><span class="p">,</span><span class="s1">'winner'</span><span class="p">,</span><span class="s1">'win_prob'</span><span class="p">]]</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt output_prompt">Out[24]:</div>
<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th></th>
<th>home_team</th>
<th>away_team</th>
<th>winner</th>
<th>win_prob</th>
</tr>
</thead>
<tbody>
<tr>
<th>1792</th>
<td>BUF</td>
<td>NYJ</td>
<td>BUF</td>
<td>0.734951</td>
</tr>
<tr>
<th>1793</th>
<td>CHI</td>
<td>ATL</td>
<td>ATL</td>
<td>0.271292</td>
</tr>
<tr>
<th>1794</th>
<td>CIN</td>
<td>BAL</td>
<td>CIN</td>
<td>0.677103</td>
</tr>
<tr>
<th>1795</th>
<td>CLE</td>
<td>PIT</td>
<td>PIT</td>
<td>0.415273</td>
</tr>
<tr>
<th>1796</th>
<td>DAL</td>
<td>NYG</td>
<td>DAL</td>
<td>0.647738</td>
</tr>
<tr>
<th>1797</th>
<td>DET</td>
<td>ARI</td>
<td>ARI</td>
<td>0.466740</td>
</tr>
<tr>
<th>1798</th>
<td>GB</td>
<td>SEA</td>
<td>GB</td>
<td>0.669675</td>
</tr>
<tr>
<th>1799</th>
<td>HOU</td>
<td>JAC</td>
<td>HOU</td>
<td>0.603226</td>
</tr>
<tr>
<th>1800</th>
<td>MIA</td>
<td>TB</td>
<td>TB</td>
<td>0.493640</td>
</tr>
<tr>
<th>1801</th>
<td>MIN</td>
<td>NO</td>
<td>MIN</td>
<td>0.605073</td>
</tr>
<tr>
<th>1802</th>
<td>NE</td>
<td>KC</td>
<td>NE</td>
<td>0.713934</td>
</tr>
<tr>
<th>1803</th>
<td>SF</td>
<td>CAR</td>
<td>SF</td>
<td>0.554278</td>
</tr>
<tr>
<th>1804</th>
<td>STL</td>
<td>IND</td>
<td>IND</td>
<td>0.185321</td>
</tr>
<tr>
<th>1805</th>
<td>TEN</td>
<td>OAK</td>
<td>TEN</td>
<td>0.530590</td>
</tr>
<tr>
<th>1806</th>
<td>WAS</td>
<td>PHI</td>
<td>WAS</td>
<td>0.676453</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Ultimately we see that the results are the same with slightly different probabilities.</p>
<h1 id="Conclusion">Conclusion<a class="anchor-link" href="#Conclusion">¶</a></h1><p>While our model makes perfectly reasonable picks, there is not reason to think that it is superior to just being mildly observant of NFL trends. The most dire limitation of the current model is failure to take into account injury. If New England loses Tom Brady,that could easily knock 10-20 percentage points from the probability of a home win.</p>
<p>Later in the year we will have more sophisticated models for predicting wins (e.g., support vector machines) as well as models for projecting individual statistics.</p>
</div>
</div>
</div>

<script type="text/javascript">if (!document.getElementById('mathjaxscript_pelican_#%@#$@#')) {
    var mathjaxscript = document.createElement('script');
    mathjaxscript.id = 'mathjaxscript_pelican_#%@#$@#';
    mathjaxscript.type = 'text/javascript';
    mathjaxscript.src = '//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML';
    mathjaxscript[(window.opera ? "innerHTML" : "text")] =
        "MathJax.Hub.Config({" +
        "    config: ['MMLorHTML.js']," +
        "    TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'AMS' } }," +
        "    jax: ['input/TeX','input/MathML','output/HTML-CSS']," +
        "    extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']," +
        "    displayAlign: 'center'," +
        "    displayIndent: '0em'," +
        "    showMathMenu: true," +
        "    tex2jax: { " +
        "        inlineMath: [ ['$','$'] ], " +
        "        displayMath: [ ['$$','$$'] ]," +
        "        processEscapes: true," +
        "        preview: 'TeX'," +
        "    }, " +
        "    'HTML-CSS': { " +
        "        styles: { '.MathJax_Display, .MathJax .mo, .MathJax .mi, .MathJax .mn': {color: 'black ! important'} }" +
        "    } " +
        "}); ";
    (document.body || document.getElementsByTagName('head')[0]).appendChild(mathjaxscript);
}
</script>

  </div>
  <div class="tag-cloud">
    <p>
      <a href="./tag/python.html">python</a>
      <a href="./tag/machine-learning.html">machine-learning</a>
      <a href="./tag/regression.html">regression</a>
      <a href="./tag/sql.html">sql</a>
      <a href="./tag/postgresql.html">postgresql</a>
      <a href="./tag/nfl.html">nfl</a>
    </p>
  </div>




</article>

    <footer>
<p>&copy; kyle thomas </p>
<p>    Powered by <a href="http://getpelican.com" target="_blank">Pelican</a> - <a href="https://github.com/alexandrevicenzi/flex" target="_blank">Flex</a> theme by <a href="http://alexandrevicenzi.com" target="_blank">Alexandre Vicenzi</a>
</p>    </footer>
  </main>





<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " cmd+build ",
  "url" : ".",
  "image": "",
  "description": ""
}
</script>
</body>
</html>